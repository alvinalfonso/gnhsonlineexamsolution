<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusExam - Multi-Course Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f5f9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS ---
        const Icon = ({ size = 20, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props} />
        );
        const Icons = {
            Shield: (p) => <Icon {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></Icon>,
            Book: (p) => <Icon {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>,
            Users: (p) => <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>,
            Plus: (p) => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>,
            Trash: (p) => <Icon {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>,
            Eye: (p) => <Icon {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
            Play: (p) => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"/></Icon>,
            LogOut: (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></Icon>,
            Cloud: (p) => <Icon {...p}><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></Icon>,
            Filter: (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>
        };

        // --- CONFIG ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCrpCFcwF9TtVMOzi2zNJYv-IVYKENC_i4",
            authDomain: "gnhs-online-exam-solution.firebaseapp.com",
            databaseURL: "https://gnhs-online-exam-solution-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gnhs-online-exam-solution",
            storageBucket: "gnhs-online-exam-solution.firebasestorage.app",
            messagingSenderId: "582595227570",
            appId: "1:582595227570:web:b912bc8c007248a085feab",
            measurementId: "G-RSTERRCZ19"
        };

        const AUTHORIZED_TEACHERS = [
            "alvin.alfonso1262@gmail.com",
            "alvin.alfonso2222@gmail.com",
            "alvina.rhss@gmail.com"
        ];

        // Init Firebase
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- HELPER: GENERATE STUDENT EXAM HTML (The "Download" feature) ---
        const downloadHtmlFile = (exam) => {
            const embeddedData = JSON.stringify(exam.questions);
            const embeddedConfig = JSON.stringify(FIREBASE_CONFIG);
            const scriptEnd = "<\/script>"; 
            
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${exam.title}</title>
<script src="https://cdn.tailwindcss.com">${scriptEnd}
<script src="https://unpkg.com/react@18/umd/react.development.js">${scriptEnd}
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js">${scriptEnd}
<script src="https://unpkg.com/@babel/standalone/babel.min.js">${scriptEnd}
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js">${scriptEnd}
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js">${scriptEnd}
<style>body{font-family:sans-serif;background:#f8fafc}.fade{animation:f .3s ease-in}@keyframes f{from{opacity:0}to{opacity:1}}</style>
</head><body><div id="root"></div><script type="text/babel">
const {useState,useEffect}=React;
const firebaseConfig=${embeddedConfig};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const EXAM_DATA={id:"${exam.id || 'downloaded'}",title:"${exam.title}",questions:${embeddedData}};
const StudentExam=()=>{
const [n,setN]=useState("");const [ans,setAns]=useState({});const [cc,setCc]=useState(0);const [st,setSt]=useState("active");
useEffect(()=>{
 const h=()=>{if(document.hidden&&st==="active"){setCc(c=>c+1);alert("Warning: Focus Lost logged.")}};
 document.addEventListener("visibilitychange",h);return()=>document.removeEventListener("visibilitychange",h);
},[st]);
const sub=()=>{
 if(!n)return alert("Name required");if(!confirm("Submit?"))return;
 setSt("submitting");
 db.ref('submissions').push({studentName:n,answers:ans,cheatStats:{count:cc},submittedAt:new Date().toISOString(),examTitle:EXAM_DATA.title,examId:EXAM_DATA.id})
 .then(()=>setSt("submitted")).catch(e=>{alert(e.message);setSt("active")});
};
if(st==="submitted")return <div className="p-10 text-center"><h1 className="text-2xl font-bold">Submitted</h1><p>Thank you, {n}.</p></div>;
return(
 <div className="max-w-2xl mx-auto p-6 bg-white min-h-screen">
  <div className="mb-6 border-b pb-4"><h1 className="text-xl font-bold">{EXAM_DATA.title}</h1></div>
  <div className="mb-6"><label className="block text-sm font-bold mb-1">Your Name</label><input className="w-full p-2 border rounded" value={n} onChange={e=>setN(e.target.value)}/></div>
  {EXAM_DATA.questions.map((q,i)=>(
   <div key={q.id} className="mb-6 p-4 border rounded bg-slate-50">
    <p className="font-medium mb-3">{i+1}. {q.text}</p>
    {q.type==='multiple_choice'?q.options.map((o,x)=><label key={x} className="block mb-2"><input type="radio" name={'q'+q.id} onChange={()=>setAns({...ans,[q.id]:o})}/> {o}</label>)
    :<textarea className="w-full p-2 border rounded" onChange={e=>setAns({...ans,[q.id]:e.target.value})}/>}
   </div>
  ))}
  <button onClick={sub} disabled={st==='submitting'} className="w-full bg-blue-600 text-white p-3 rounded font-bold">{st==='submitting'?'Uploading...':'Submit Exam'}</button>
 </div>
)};
const root=ReactDOM.createRoot(document.getElementById('root'));root.render(<StudentExam/>);
${scriptEnd}</body></html>`;

            try {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${exam.title.replace(/\s+/g, '_')}_Exam.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                alert("Download failed.");
            }
        };

        // --- COMPONENTS ---

        // 1. EXAM CARD (Teacher View)
        const ExamCard = ({ exam, onToggleStatus, onDelete, onViewResults, onDownload }) => {
            return (
                <div className={`bg-white rounded-xl shadow-sm border-l-4 p-5 mb-4 flex justify-between items-center transition-all ${exam.status === 'published' ? 'border-green-500 shadow-green-100' : 'border-slate-300'}`}>
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                            <h3 className="font-bold text-lg text-slate-800">{exam.title}</h3>
                            <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200">{exam.subject}</span>
                            <span className="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">{exam.yearLevel}</span>
                        </div>
                        <p className="text-sm text-slate-500">
                            Created: {new Date(exam.createdAt).toLocaleDateString()} • {exam.questions?.length || 0} Questions
                        </p>
                    </div>
                    <div className="flex items-center gap-3">
                        <button 
                            onClick={() => onToggleStatus(exam)}
                            className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors ${exam.status === 'published' ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                        >
                            <Icons.Cloud size={14} />
                            {exam.status === 'published' ? 'Published' : 'Draft'}
                        </button>
                        <button onClick={() => onDownload(exam)} className="text-slate-500 hover:bg-slate-100 p-2 rounded-lg" title="Download HTML"><Icons.Download size={18}/></button>
                        <button onClick={() => onViewResults(exam.id)} className="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg" title="View Results"><Icons.Eye size={18}/></button>
                        <button onClick={() => onDelete(exam.id)} className="text-red-400 hover:bg-red-50 p-2 rounded-lg" title="Delete"><Icons.Trash size={18}/></button>
                    </div>
                </div>
            );
        };

        // 2. TEACHER DASHBOARD
        const TeacherDashboard = ({ user, onLogout }) => {
            const [view, setView] = useState("list"); // list, create, results
            const [exams, setExams] = useState([]);
            const [selectedExamId, setSelectedExamId] = useState(null);
            
            // Create Form State
            const [newExam, setNewExam] = useState({ title: "", subject: "", yearLevel: "", questions: [] });
            const [qType, setQType] = useState("multiple_choice");
            const [curQ, setCurQ] = useState({ text: "", options: ["","","",""], correctAnswer: "" });

            // Load Exams
            useEffect(() => {
                db.ref('exams').on('value', s => {
                    const data = s.val();
                    if(data) {
                        // Sort by newest first
                        setExams(Object.entries(data).map(([k,v]) => ({id:k, ...v})).reverse());
                    } else setExams([]);
                });
            }, []);

            const saveExam = () => {
                if(!newExam.title || !newExam.subject || !newExam.yearLevel) return alert("Please fill in all details.");
                if(newExam.questions.length === 0) return alert("Add at least one question.");
                
                db.ref('exams').push({
                    ...newExam,
                    teacher: user.email,
                    createdAt: new Date().toISOString(),
                    status: 'draft' 
                });
                setNewExam({ title: "", subject: "", yearLevel: "", questions: [] });
                setView("list");
            };

            const toggleStatus = (exam) => {
                const newStatus = exam.status === 'published' ? 'draft' : 'published';
                db.ref(`exams/${exam.id}/status`).set(newStatus);
            };

            const deleteExam = (id) => {
                if(confirm("Delete this exam permanently?")) db.ref(`exams/${id}`).remove();
            };

            const addQuestion = () => {
                if(!curQ.text) return;
                setNewExam({...newExam, questions: [...newExam.questions, {...curQ, id: Date.now(), type: qType}]});
                setCurQ({ text: "", options: ["","","",""], correctAnswer: "" });
            };

            const setOption = (idx, val) => {
                const n = [...curQ.options]; n[idx] = val;
                if(curQ.correctAnswer === curQ.options[idx]) setCurQ({...curQ, options:n, correctAnswer:val});
                else setCurQ({...curQ, options:n});
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8 animate-fade-in text-slate-800">
                    <header className="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h1 className="text-2xl font-bold flex items-center gap-2 text-indigo-900"><Icons.Shield className="text-indigo-600"/> FocusExam</h1>
                            <p className="text-xs text-slate-500">Welcome, {user.email}</p>
                        </div>
                        <div className="flex gap-2">
                            {view !== 'list' && <button onClick={() => setView('list')} className="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg">Back to Dashboard</button>}
                            <button onClick={onLogout} className="p-2 text-slate-400 hover:text-red-500 rounded-lg"><Icons.LogOut/></button>
                        </div>
                    </header>

                    {view === 'list' && (
                        <div>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-slate-700">Exam Management</h2>
                                <button onClick={() => setView('create')} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-indigo-700 shadow-lg shadow-indigo-200"><Icons.Plus size={18}/> Create New Exam</button>
                            </div>
                            
                            <div className="grid gap-2">
                                {exams.length === 0 ? <div className="text-center py-20 text-slate-400">No exams created yet.</div> : 
                                exams.map(ex => (
                                    <ExamCard 
                                        key={ex.id} 
                                        exam={ex} 
                                        onToggleStatus={toggleStatus} 
                                        onDelete={deleteExam}
                                        onDownload={downloadHtmlFile}
                                        onViewResults={(id) => { setSelectedExamId(id); setView('results'); }}
                                    />
                                ))}
                            </div>
                        </div>
                    )}

                    {view === 'create' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-1 space-y-4">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.Book size={18}/> Exam Info</h3>
                                    <div className="space-y-3">
                                        <input className="w-full p-2 border rounded text-sm" placeholder="Exam Title (e.g. Midterms)" value={newExam.title} onChange={e => setNewExam({...newExam, title: e.target.value})} />
                                        <input className="w-full p-2 border rounded text-sm" placeholder="Subject (e.g. Science)" value={newExam.subject} onChange={e => setNewExam({...newExam, subject: e.target.value})} />
                                        <input className="w-full p-2 border rounded text-sm" placeholder="Year Level (e.g. Grade 10)" value={newExam.yearLevel} onChange={e => setNewExam({...newExam, yearLevel: e.target.value})} />
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                    <h3 className="font-bold text-slate-700 mb-4">Add Question</h3>
                                    <div className="flex gap-2 mb-3 bg-slate-100 p-1 rounded-lg">
                                        {['multiple_choice', 'identification', 'essay'].map(t => (
                                            <button key={t} onClick={() => setQType(t)} className={`flex-1 py-1 text-[10px] font-bold uppercase rounded ${qType === t ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>{t.replace('_', ' ').substring(0,8)}</button>
                                        ))}
                                    </div>
                                    <textarea className="w-full p-2 border rounded text-sm h-20 mb-2" placeholder="Question text..." value={curQ.text} onChange={e => setCurQ({...curQ, text: e.target.value})}></textarea>
                                    
                                    {qType === 'multiple_choice' && curQ.options.map((o, i) => (
                                        <div key={i} className="flex items-center gap-2 mb-2">
                                            <input type="radio" name="c" checked={curQ.correctAnswer === o && o !== ""} onChange={() => setCurQ({...curQ, correctAnswer: o})} className="accent-indigo-600"/>
                                            <input className="flex-1 p-1.5 border rounded text-xs" placeholder={`Option ${i+1}`} value={o} onChange={e => setOption(i, e.target.value)}/>
                                        </div>
                                    ))}
                                    {qType === 'identification' && <input className="w-full p-2 border rounded text-sm border-green-200 bg-green-50 mb-2" placeholder="Correct Answer Key" value={curQ.correctAnswer} onChange={e => setCurQ({...curQ, correctAnswer: e.target.value})} />}
                                    
                                    <button onClick={addQuestion} className="w-full bg-slate-800 text-white py-2 rounded-lg font-bold text-sm hover:bg-slate-900">Add to List</button>
                                </div>
                                <button onClick={saveExam} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700">Save Exam Draft</button>
                            </div>
                            
                            <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 className="font-bold border-b pb-2 mb-4 text-slate-500">Questions Preview ({newExam.questions.length})</h3>
                                <div className="space-y-4 max-h-[600px] overflow-y-auto">
                                    {newExam.questions.map((q, i) => (
                                        <div key={i} className="p-4 border rounded bg-slate-50 relative">
                                            <p className="font-bold text-slate-800">{i+1}. {q.text}</p>
                                            {q.type === 'multiple_choice' && <div className="ml-4 mt-2 border-l-2 pl-2 space-y-1">{q.options.map((o, idx) => <div key={idx} className={`text-sm ${q.correctAnswer === o ? 'text-green-600 font-bold' : 'text-slate-500'}`}>{o}</div>)}</div>}
                                            {q.type === 'identification' && <div className="mt-2 text-xs bg-green-100 text-green-800 w-fit px-2 py-1 rounded">Key: {q.correctAnswer}</div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'results' && <ResultsDashboard examId={selectedExamId} onClose={() => setView('list')} />}
                </div>
            );
        };

        // 3. RESULTS DASHBOARD
        const ResultsDashboard = ({ examId, onClose }) => {
            const [subs, setSubs] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                db.ref('submissions').orderByChild('examId').equalTo(examId).on('value', s => {
                    const data = s.val();
                    if(data) setSubs(Object.values(data));
                    else setSubs([]);
                    setLoading(false);
                });
            }, [examId]);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 min-h-[600px]">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold">Exam Results</h2>
                        <button onClick={onClose} className="text-sm text-slate-500">Back</button>
                    </div>
                    {loading ? <p>Loading...</p> : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-100"><tr><th className="p-3">Student</th><th className="p-3">Time</th><th className="p-3">Integrity</th><th className="p-3">Data</th></tr></thead>
                                <tbody>
                                    {subs.map((s, i) => (
                                        <tr key={i} className="border-b">
                                            <td className="p-3 font-medium">{s.studentName}</td>
                                            <td className="p-3">{new Date(s.submittedAt).toLocaleString()}</td>
                                            <td className="p-3"><span className={`px-2 py-1 rounded text-xs ${s.cheatStats?.count > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{s.cheatStats?.count || 0} Flags</span></td>
                                            <td className="p-3"><button onClick={()=>alert(JSON.stringify(s.answers, null, 2))} className="text-blue-600 underline">Answers</button></td>
                                        </tr>
                                    ))}
                                    {subs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No submissions yet.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // 4. STUDENT PORTAL (Smart Filter)
        const StudentPortal = ({ onBack }) => {
            const [exams, setExams] = useState([]);
            const [filteredExams, setFilteredExams] = useState([]);
            
            // Filter States
            const [selectedYear, setSelectedYear] = useState("");
            const [selectedSubject, setSelectedSubject] = useState("");
            
            // Exam States
            const [activeExam, setActiveExam] = useState(null);
            const [studentName, setStudentName] = useState("");
            const [status, setStatus] = useState("lobby"); // lobby, ready, taking, submitted
            const [answers, setAnswers] = useState({});
            const [cheatCount, setCheatCount] = useState(0);

            // Load Published Exams
            useEffect(() => {
                db.ref('exams').orderByChild('status').equalTo('published').on('value', s => {
                    const data = s.val();
                    if (data) {
                        const list = Object.entries(data).map(([k,v]) => ({id:k, ...v}));
                        setExams(list);
                    } else setExams([]);
                });
            }, []);

            // Filter Logic
            useEffect(() => {
                if (!selectedYear || !selectedSubject) {
                    setFilteredExams([]);
                    return;
                }
                const matches = exams.filter(e => 
                    e.yearLevel.toLowerCase().includes(selectedYear.toLowerCase()) && 
                    e.subject.toLowerCase().includes(selectedSubject.toLowerCase())
                );
                setFilteredExams(matches);
            }, [selectedYear, selectedSubject, exams]);

            // Cheat Detection
            useEffect(() => {
                if (status !== 'taking') return;
                const h = () => { if (document.hidden) setCheatCount(c => c + 1); };
                document.addEventListener("visibilitychange", h);
                return () => document.removeEventListener("visibilitychange", h);
            }, [status]);

            const submit = () => {
                if(!confirm("Submit?")) return;
                db.ref('submissions').push({
                    examId: activeExam.id,
                    examTitle: activeExam.title,
                    studentName,
                    answers,
                    cheatStats: { count: cheatCount },
                    submittedAt: new Date().toISOString()
                }).then(() => setStatus('submitted'));
            };

            // VIEW: LOBBY
            if (status === 'lobby') {
                // Extract unique Years and Subjects for dropdowns
                const years = [...new Set(exams.map(e => e.yearLevel))];
                const subjects = [...new Set(exams.map(e => e.subject))];

                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 relative">
                            <button onClick={onBack} className="absolute top-4 left-4 text-slate-400 hover:text-slate-600"><Icon size={24}><path d="m15 18-6-6 6-6"/></Icon></button>
                            <div className="text-center mb-8">
                                <h2 className="text-2xl font-bold text-slate-800">Student Portal</h2>
                                <p className="text-slate-500">Find your exam below</p>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Step 1: Select Year</label>
                                    <select className="w-full p-3 border rounded-lg bg-slate-50" value={selectedYear} onChange={e => setSelectedYear(e.target.value)}>
                                        <option value="">-- Choose Year --</option>
                                        {years.map(y => <option key={y} value={y}>{y}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">Step 2: Select Subject</label>
                                    <select className="w-full p-3 border rounded-lg bg-slate-50" value={selectedSubject} onChange={e => setSelectedSubject(e.target.value)} disabled={!selectedYear}>
                                        <option value="">-- Choose Subject --</option>
                                        {subjects.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                            </div>

                            {selectedYear && selectedSubject && (
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Available Exams</label>
                                    {filteredExams.length === 0 ? <p className="text-slate-400 text-center py-4 bg-slate-50 rounded">No active exams found.</p> : 
                                    filteredExams.map(ex => (
                                        <button key={ex.id} onClick={() => { setActiveExam(ex); setStatus('ready'); }} className="w-full p-4 border border-indigo-100 bg-indigo-50 hover:bg-indigo-100 rounded-xl text-left flex justify-between items-center group">
                                            <span className="font-bold text-indigo-900">{ex.title}</span>
                                            <Icons.Play className="text-indigo-400 group-hover:text-indigo-600"/>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // VIEW: READY
            if (status === 'ready') return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
                        <button onClick={() => setStatus('lobby')} className="text-slate-400 text-sm mb-4">Back</button>
                        <h2 className="text-2xl font-bold text-green-700 mb-1">Start Exam</h2>
                        <p className="text-slate-600 mb-6">{activeExam.title} - {activeExam.subject}</p>
                        <input className="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Enter Full Name" value={studentName} onChange={e => setStudentName(e.target.value)} />
                        <button onClick={() => { if(studentName) setStatus('taking'); else alert("Name required"); }} className="w-full bg-green-600 text-white p-3 rounded-lg font-bold shadow-lg hover:bg-green-700">Begin Exam</button>
                    </div>
                </div>
            );

            // VIEW: TAKING
            if (status === 'taking') return (
                <div className="min-h-screen bg-slate-50 p-6">
                    <div className="max-w-3xl mx-auto">
                        <div className="bg-white p-4 rounded shadow mb-6 sticky top-0 z-10 flex justify-between border-b-4 border-indigo-500 shadow-md">
                            <div>
                                <span className="font-bold text-lg text-slate-800 block">{activeExam.title}</span>
                                <span className="text-xs text-slate-500">{studentName} • {activeExam.subject}</span>
                            </div>
                            <div className={`px-3 py-1 rounded h-fit text-xs font-bold ${cheatCount>0?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{cheatCount>0?'Flagged':'Secure'}</div>
                        </div>
                        {activeExam.questions.map((q, i) => (
                            <div key={i} className="bg-white p-6 rounded-xl shadow-sm mb-4">
                                <p className="font-bold mb-3 text-lg text-slate-800">{i+1}. {q.text}</p>
                                {q.type === 'multiple_choice' ? q.options.map((o, x) => <label key={x} className="flex items-center gap-3 p-3 border rounded-lg hover:bg-slate-50 mb-2 cursor-pointer"><input type="radio" name={'q'+i} onChange={()=>setAnswers({...answers, [q.id]:o})}/> {o}</label>)
                                : <textarea className="w-full border p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Answer..." rows="3" onChange={e=>setAnswers({...answers, [q.id]:e.target.value})}/>}
                            </div>
                        ))}
                        <button onClick={submit} className="w-full bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-transform active:scale-95">Submit Final Answers</button>
                    </div>
                </div>
            );

            return <div className="min-h-screen flex items-center justify-center flex-col"><div className="bg-green-100 p-6 rounded-full mb-4 text-green-600"><Icons.Check size={64}/></div><h1 className="text-2xl font-bold">Exam Submitted!</h1><button onClick={()=>window.location.reload()} className="mt-4 underline text-blue-600">Return Home</button></div>;
        };

        // 5. LANDING PAGE
        const LandingPage = ({ onSelectRole }) => (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row">
                    <div className="bg-slate-900 p-10 flex flex-col justify-center text-white md:w-5/12">
                        <div className="mb-6"><Icons.Shield size={64} className="text-indigo-400"/></div>
                        <h1 className="text-4xl font-bold mb-4">FocusExam</h1>
                        <p className="text-slate-300 text-lg leading-relaxed">A secure, integrity-focused testing platform for modern education.</p>
                    </div>
                    <div className="p-10 flex flex-col justify-center md:w-7/12">
                        <h2 className="text-2xl font-bold text-slate-800 mb-8 text-center">Select Your Role</h2>
                        <div className="space-y-4">
                            <button onClick={() => onSelectRole('teacher')} className="w-full flex items-center p-4 border-2 border-slate-200 rounded-xl hover:border-indigo-600 hover:bg-indigo-50 transition-all group text-left">
                                <div className="bg-indigo-100 p-3 rounded-full mr-4 group-hover:bg-indigo-600 group-hover:text-white transition-colors"><Icons.Users size={24}/></div>
                                <div><h3 className="font-bold text-lg text-slate-800">I am a Teacher</h3><p className="text-slate-500 text-sm">Create and assign exams</p></div>
                            </button>
                            <button onClick={() => onSelectRole('student')} className="w-full flex items-center p-4 border-2 border-slate-200 rounded-xl hover:border-green-600 hover:bg-green-50 transition-all group text-left">
                                <div className="bg-green-100 p-3 rounded-full mr-4 group-hover:bg-green-600 group-hover:text-white transition-colors"><Icons.Book size={24}/></div>
                                <div><h3 className="font-bold text-lg text-slate-800">I am a Student</h3><p className="text-slate-500 text-sm">Take assigned exams</p></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP CONTROLLER ---
        const App = () => {
            const [page, setPage] = useState('landing');
            const [user, setUser] = useState(null);

            const handleTeacherLogin = () => {
                const p = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(p).then(res => {
                    if (AUTHORIZED_TEACHERS.includes(res.user.email)) {
                        setUser(res.user);
                        setPage('teacher');
                    } else {
                        auth.signOut();
                        alert("Access Denied: Not an authorized teacher account.");
                    }
                }).catch(e => alert(e.message));
            };

            if (page === 'landing') return <LandingPage onSelectRole={r => r === 'teacher' ? handleTeacherLogin() : setPage('student')} />;
            if (page === 'student') return <StudentPortal onBack={() => setPage('landing')} />;
            if (page === 'teacher' && user) return <TeacherDashboard user={user} onLogout={() => { auth.signOut(); setPage('landing'); }} />;
            return <div className="min-h-screen flex items-center justify-center text-slate-400">Loading FocusExam...</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
